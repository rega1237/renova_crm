<div class="p-4 sm:p-8">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
    <h1 class="font-poppins text-3xl font-bold text-rojo-carmesi">
      Clientes
    </h1>
    <%= link_to "Nuevo Cliente", new_client_path, class: "bg-rojo-carmesi text-white font-poppins font-semibold py-2 px-5 rounded-lg hover:opacity-90 transition-opacity" %>
  </div>
  <div class="mb-8">
    <%= form_with url: clients_path, method: :get, class: "bg-white p-4 rounded-xl shadow-md" do |form| %>
      <div class="flex flex-col lg:flex-row items-center gap-4">
        <!-- Campo de búsqueda más pequeño -->
        <div class="w-full lg:w-80">
          <%= text_field_tag :query, params[:query], class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat", placeholder: "Buscar por nombre..." %>
        </div>
        <!-- Filtros de selección -->
        <div class="w-full lg:w-auto">
          <%= select_tag :status, options_for_select(Client.statuses.keys.map { |s| [status_display_name(s), s] }, params[:status]), include_blank: 'Todos los Estados del Cliente', class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat" %>
        </div>
        <div class="w-full lg:w-auto">
          <%= select_tag :source, options_for_select(Client.sources.keys.map { |s| [s.humanize.gsub('_', ' '), s] }, params[:source]), include_blank: 'Todas las Fuentes', class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat" %>
        </div>
        <div class="w-full lg:w-auto">
          <%= select_tag :state_id, options_from_collection_for_select(State.ordered, :id, :display_name_with_abbreviation, params[:state_id]), include_blank: 'Todos los Estados', class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat" %>
        </div>
        <!-- Filtro campos de fecha -->
        <div class="w-full lg:w-auto">
          <%= date_field_tag :date_from, params[:date_from], class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat", placeholder: "Fecha desde" %>
        </div>
        <div class="w-full lg:w-auto">
          <%= date_field_tag :date_to, params[:date_to], class: "mt-1 block w-full border-gray-300 rounded-md shadow-sm px-4 py-2 focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 font-montserrat", placeholder: "Fecha hasta" %>
        </div>
        <!-- Botones -->
        <div class="flex items-center gap-2 w-full lg:w-auto">
          <%= form.submit "Filtrar", class: "bg-negro-onix text-white font-poppins font-semibold py-2 px-4 rounded-lg cursor-pointer hover:opacity-90 transition-opacity" %>
          <%= link_to "Limpiar", clients_path, class: "text-gray-500 font-poppins font-medium py-2 px-4 hover:text-gray-700 transition-colors whitespace-nowrap" %>
        </div>
      </div>
    <% end %>
  </div>
  <div class="bg-white rounded-xl shadow-md">
    <ul class="divide-y divide-gray-200">
      <% if @clients.any? %>
        <% @clients.each do |client| %>
          <li class="p-4 hover:bg-humo transition-colors duration-200">
            <%= link_to client_path(client), data: { turbo_frame: "slideover" }, class: "flex items-center space-x-4" do %>
              <div class="flex-shrink-0 w-12 h-12 bg-rojo-carmesi rounded-full flex items-center justify-center">
                <span class="text-xl font-poppins font-bold text-white">
                  <%= client.name.first.upcase %>
                </span>
              </div>
              <div class="flex-grow">
                <p class="font-poppins font-semibold text-negro-onix"><%= client.name %></p>
                <div class="flex items-center gap-2">
                  <p class="font-montserrat text-sm text-gray-500"><%= client.phone %></p>
                  <% if client.state.present? %>
                    <span class="px-2 py-1 text-xs leading-4 font-semibold rounded-full bg-gray-100 text-gray-600 font-montserrat">
                      <%= client.state.abbreviation %>
                    </span>
                  <% end %>
                </div>

                <!-- Indicador de que necesita vendedor asignado -->
                <div class="mt-0.5">
                <% if client.assigned_seller.present? %>
                  <!-- Vendedor asignado (más importante para el flujo de ventas) -->
                  <div class="flex items-center">
                    <svg class="w-3 h-3 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-montserrat text-xs text-green-700 truncate">
                      Asignado: <%= client.assigned_seller.name %>
                    </span>
                  </div>
                <% elsif client.requires_assigned_seller? %>
                  <!-- Indicador de que necesita vendedor asignado -->
                  <div class="flex items-center">
                    <svg class="w-3 h-3 text-yellow-500 mr-1" fill="currentColor" viewBox="0 0 24 24">
                      <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span class="font-montserrat text-xs text-yellow-600">
                      Necesita vendedor
                    </span>
                  </div>
                <% elsif client.prospecting_seller.present? %>
                  <!-- Vendedor que generó el prospecto -->
                  <div class="flex items-center">
                    <svg class="w-3 h-3 text-blue-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-montserrat text-xs text-blue-600 truncate">
                      Prospecto: <%= client.prospecting_seller.name %>
                    </span>
                  </div>
                <% end %>
                </div>


                <!-- Información adicional de fechas -->
                <div class="flex items-center gap-2 mt-1">
                  <% if client.status == 'lead' %>
                    <span class="text-xs text-gray-400 font-montserrat">
                      Creado: <%= client.created_at.strftime("%d/%m/%Y") %>
                    </span>
                  <% elsif client.updated_status_at.present? %>
                    <span class="text-xs text-gray-400 font-montserrat">
                      Actualizado: <%= client.updated_status_at.strftime("%d/%m/%Y") %>
                    </span>
                    <% if client.updated_by.present? %>
                      <span class="text-xs text-gray-400 font-montserrat">
                        por <%= client.updated_by.name %>
                      </span>
                    <% end %>
                  <% end %>
                </div>
              </div>
              <div class="flex-shrink-0 text-right">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full font-montserrat
                  <% case client.status %>
                  <% when 'lead' %>
                    bg-blue-100 text-blue-800
                  <% when 'no_contesto' %>
                    bg-gray-100 text-gray-800
                  <% when 'seguimiento' %>
                    bg-yellow-100 text-yellow-800
                  <% when 'cita_agendada' %>
                    bg-purple-100 text-purple-800
                  <% when 'reprogramar' %>
                    bg-orange-100 text-orange-800
                  <% when 'vendido' %>
                    bg-green-100 text-green-800
                  <% when 'mal_credito' %>
                    bg-red-100 text-red-800
                  <% when 'no_cerro' %>
                    bg-red-100 text-red-800
                  <% when 'no_aplica_no_interesado' %>
                    bg-red-100 text-red-800
                  <% else %>
                    bg-gray-100 text-gray-800
                  <% end %>">
                  <%= status_display_name(client.status) %>
                </span>
                <p class="font-montserrat text-sm mt-1">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800 font-montserrat">
                    <%= client.source.humanize.gsub('_', ' ') %>
                  </span>
                </p>
              </div>
            <% end %>
          </li>
        <% end %>
      <% else %>
        <li class="p-8 text-center font-montserrat text-gray-500">
          No se encontraron clientes con los filtros seleccionados.
        </li>
      <% end %>
    </ul>
  </div>
</div>
<%= turbo_frame_tag "slideover" %>