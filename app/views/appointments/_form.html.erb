<div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
  <h3 class="font-poppins text-lg font-semibold text-negro-onix mb-4">Agendar Nueva Cita</h3>

  <%= form_with model: [client, appointment], local: false, data: { turbo_frame: "appointment-form-container" } do |form| %>
    <% if form.object.errors.any? %>
      <div class="mb-4 p-3 bg-red-100 text-red-800 rounded-md">
        <h4 class="font-bold">Se encontraron <%= pluralize(form.object.errors.count, "error") %>:</h4>
        <ul>
          <% form.object.errors.full_messages.each do |message| %>
            <li class="text-sm"><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="space-y-4">
      <div>
        <%= form.label :title, "Título", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :title, value: "Cita con #{client.name}", class: "mt-1 px-3 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm" %>
      </div>

      <div>
        <%= form.label :description, "Descripción", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_area :description, rows: 3, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm" %>
      </div>

      <!-- Campo de Dirección con Autocompletado -->
      <div data-controller="address-autocomplete">
        <%= form.label :address, "Dirección", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :address, 
            class: "mt-1 px-3 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm",
            data: { address_autocomplete_target: "input", action: "input->address-autocomplete#search" } %>
        <div data-address-autocomplete-target="results" class="relative z-10"></div>
      </div>

      <div>
        <%= form.label :start_time, "Fecha y hora de la cita", class: "block text-sm font-medium text-gray-700" %>
        <%= form.datetime_local_field :start_time, class: "mt-1 px-3 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm" %>
      </div>

      <div>
        <%= form.label :seller_id, "Asignar Vendedor (Opcional)", class: "block text-sm font-medium text-gray-700" %>
        <%= form.collection_select :seller_id, Seller.all, :id, :name, { include_blank: "Sin asignar" }, { class: "mt-1 px-3 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm" } %>
      </div>

      <!-- Selector de Usuario que agenda la cita -->
      <div>
        <%= form.label :created_by_id, "Agendado por", class: "block text-sm font-medium text-gray-700" %>
        <%= form.collection_select :created_by_id, User.order(:name), :id, :name, { include_blank: false, selected: (form.object.created_by_id || Current.user&.id) }, { class: "mt-1 px-3 py-2 block w-full rounded-md border-gray-300 shadow-sm focus:outline-none focus:border-rojo-carmesi focus:ring focus:ring-rojo-carmesi focus:ring-opacity-50 sm:text-sm" } %>
      </div>
    </div>

    <div class="mt-6 flex items-center justify-end gap-x-4">
      <button type="button" data-action="click->toggle#toggle" class="text-sm font-semibold leading-6 text-gray-900">Cancelar</button>
      <%= form.submit "Guardar Cita", class: "rounded-md bg-rojo-carmesi px-4 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rojo-carmesi" %>
    </div>
  <% end %>
</div>
