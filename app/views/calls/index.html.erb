<div class="bg-white p-6 rounded-xl shadow-md">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
    <h1 class="font-poppins text-3xl font-bold text-rojo-carmesi mb-4 sm:mb-0">
      Registro de Llamadas
    </h1>

    <div class="flex flex-col sm:flex-row gap-3">
      <%= form_with url: calls_path, method: :get, local: true, class: "flex flex-col sm:flex-row gap-3" do |form| %>
        <% if current_user&.admin? %>
          <div class="flex flex-col">
            <%= form.label :user_id, "Usuario", class: "text-sm font-poppins font-medium text-gray-700 mb-1" %>
            <%= form.select :user_id, 
                  options_from_collection_for_select(@users, 'id', 'name', @user_id), 
                  { include_blank: 'Todos' }, 
                  class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-rojo-carmesi focus:border-rojo-carmesi font-montserrat text-sm" %>
          </div>
          <div class="flex flex-col">
            <%= form.label :answered, "Atendida", class: "text-sm font-poppins font-medium text-gray-700 mb-1" %>
            <%= form.select :answered,
                  options_for_select([
                    ['Todas', nil],
                    ['Sí', 'yes'],
                    ['No', 'no']
                  ], @answered),
                  {},
                  class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-rojo-carmesi focus:border-rojo-carmesi font-montserrat text-sm" %>
          </div>
        <% end %>
        <% unless current_user&.admin? %>
          <div class="flex flex-col">
            <%= form.label :answered, "Atendida", class: "text-sm font-poppins font-medium text-gray-700 mb-1" %>
            <%= form.select :answered,
                  options_for_select([
                    ['Todas', nil],
                    ['Sí', 'yes'],
                    ['No', 'no']
                  ], @answered),
                  {},
                  class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-rojo-carmesi focus:border-rojo-carmesi font-montserrat text-sm" %>
          </div>
        <% end %>
        <div class="flex flex-col">
          <%= form.label :start_date, "Fecha inicio", class: "text-sm font-poppins font-medium text-gray-700 mb-1" %>
          <%= form.date_field :start_date, value: @start_date, class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-rojo-carmesi focus:border-rojo-carmesi font-montserrat text-sm" %>
        </div>
        <div class="flex flex-col">
          <%= form.label :end_date, "Fecha fin", class: "text-sm font-poppins font-medium text-gray-700 mb-1" %>
          <%= form.date_field :end_date, value: @end_date, class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-rojo-carmesi focus:border-rojo-carmesi font-montserrat text-sm" %>
        </div>
        <div class="flex items-end gap-2">
          <%= form.submit "Filtrar", class: "bg-rojo-carmesi text-white font-poppins font-medium py-2 px-4 rounded-md hover:opacity-90 transition-opacity text-sm" %>
          <%= link_to "Limpiar", calls_path, class: "bg-gray-500 text-white font-poppins font-medium py-2 px-4 rounded-md hover:opacity-90 transition-opacity text-sm" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
      <div class="text-xs font-poppins uppercase tracking-wide text-gray-500">Total llamadas</div>
      <div class="mt-2 text-2xl font-poppins font-bold text-negro-onix"><%= @total_count %></div>
    </div>
    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
      <div class="text-xs font-poppins uppercase tracking-wide text-green-700">Llamadas atendidas</div>
      <div class="mt-2 text-2xl font-poppins font-bold text-green-700"><%= @answered_count %></div>
    </div>
    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
      <div class="text-xs font-poppins uppercase tracking-wide text-red-700">Llamadas no atendidas</div>
      <div class="mt-2 text-2xl font-poppins font-bold text-red-700"><%= @unanswered_count %></div>
    </div>
  </div>

  <% if @calls.any? %>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Twilio SID</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duración (s)</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dirección</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Atendida</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @calls.each do |call| %>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-3 font-montserrat text-sm text-negro-onix"><%= call.twilio_call_id %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.call_date.strftime('%d/%m/%Y') %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.call_time.strftime('%H:%M:%S') %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.user&.name || "-" %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700">
                <% if call.client.present? %>
                  <%= link_to(call.client.name,
                              client_path(call.client),
                              data: { turbo_frame: "slideover" },
                              class: "text-rojo-carmesi hover:underline") %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.duration || "-" %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.direction || '-' %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700"><%= call.status || '-' %></td>
              <td class="px-4 py-3 font-montserrat text-sm text-gray-700">
                <% atendida = call.respond_to?(:effective_answered?) ? call.effective_answered? : (call.duration.to_i > 0) %>
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-poppins <%= atendida ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>">
                  <%= atendida ? 'Sí' : 'No' %>
                </span>
              </td>
              <td class="px-4 py-3 text-right">
                <%= link_to "Ver", call_path(call), class: "text-rojo-carmesi font-poppins text-sm hover:underline mr-3" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex items-center justify-between mt-4">
      <div class="font-montserrat text-sm text-gray-600">
        Página <%= @page %> de <%= @total_pages %> — <%= @total_count %> llamadas
      </div>
      <div class="flex gap-2">
        <% prev_page = @page - 1 %>
        <% next_page = @page + 1 %>
        <%= link_to "Anterior", calls_path(request.query_parameters.merge(page: prev_page)), class: "px-3 py-2 border border-gray-300 rounded-md font-poppins text-sm #{prev_page < 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}", disabled: prev_page < 1 %>
        <%= link_to "Siguiente", calls_path(request.query_parameters.merge(page: next_page)), class: "px-3 py-2 border border-gray-300 rounded-md font-poppins text-sm #{@page >= @total_pages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}", disabled: @page >= @total_pages %>
      </div>
    </div>
  <% else %>
    <div class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h18M3 10h18M3 15h18" />
      </svg>
      <h3 class="mt-2 text-sm font-poppins font-medium text-gray-900">No hay llamadas</h3>
      <p class="mt-1 text-sm font-montserrat text-gray-500">
        <% if @user_id.present? || @start_date.present? || @end_date.present? %>
          No se encontraron llamadas para los filtros seleccionados.
        <% else %>
          Aún no hay registros de llamadas.
        <% end %>
      </p>
    </div>
  <% end %>
  <!-- Frame para renderizar el slideover del cliente vía Turbo -->
  <%= turbo_frame_tag "slideover" %>
</div>